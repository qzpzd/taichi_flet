import requests
from bs4 import BeautifulSoup
import  flet as ft
import sys 
sys.path.append('TAICHI-flet')
from views.treasure_dialogs.base import BaseDialog
from methods.getweather import get_weather_info

class Dialog(BaseDialog):
    def __init__(self):

        # 创建城市名称到数字代号的映射字典
        self.city_mapping = {
            "北京市": "101010100",
            "上海市": "101020100",
            "广州市": "101280101",
            "深圳市": "101280601",
            "重庆市": "101040100",
            "天津市": "101030100",
            "杭州市": "101210101",
            "南京市": "101190101",
            "武汉市": "101200101",
            "成都市": "101270101",
            "西安市": "101110101",
            "郑州市": "101180101",
            "哈尔滨市": "101050101",
            "长春市": "101060101",
            "沈阳市": "101070101",
            "济南市": "101120101",
            "青岛市": "101120201",
            "大连市": "101070201",
            "宁波市": "101210401",
            "厦门市": "101230201",
            "福州市": "101230101",
            "南昌市": "101240101",
            "广州市": "101280101",
            "深圳市": "101280601",
            "珠海市": "101280701",
            "佛山市": "101280800",
            "汕头市": "101282001",
            "南宁市": "101300101",
            "海口市": "101310101",
            "三亚市": "101310201",
            "重庆市": "101040100",
            "成都市": "101270101",
            "贵阳市": "101260101",
            "昆明市": "101290101",
            "拉萨市": "101140101",
            "西宁市": "101150101",
            "银川市": "101170101",
            "乌鲁木齐市": "101130101",
            # 添加更多城市映射
        }


        self.area_data = {
            "北京市": {
                "北京市": ["东城区", "西城区", "朝阳区", "海淀区", "丰台区", "石景山区", "门头沟区", "房山区", "通州区", "顺义区", "昌平区", "大兴区", "怀柔区", "平谷区", "密云区", "延庆区"]
            },
            "天津市": {
                "天津市": ["和平区", "河东区", "河西区", "南开区", "河北区", "红桥区", "东丽区", "西青区", "津南区", "北辰区", "武清区", "宝坻区", "滨海新区", "宁河区", "静海区", "蓟州区"]
            },
            "上海市": {
                "上海市": ["黄浦区", "徐汇区", "长宁区", "静安区", "普陀区", "虹口区", "杨浦区", "闵行区", "宝山区", "嘉定区", "浦东新区", "金山区", "松江区", "青浦区", "奉贤区", "崇明区"]
            },
            "重庆市": {
                "重庆市": ["渝中区", "大渡口区", "江北区", "沙坪坝区", "九龙坡区", "南岸区", "北碚区", "渝北区", "巴南区", "黔江区", "长寿区", "江津区", "合川区", "永川区", "南川区", "綦江区", "大足区", "铜梁区", "荣昌区", "璧山区", "梁平区", "城口县", "丰都县", "垫江县", "武隆区", "忠县", "开州区", "云阳县", "奉节县", "巫山县", "巫溪县", "石柱土家族自治县", "秀山土家族苗族自治县", "酉阳土家族苗族自治县", "彭水苗族土家族自治县"]
            },
            "广东省": {
                "广州市": ["越秀区", "荔湾区", "天河区", "海珠区", "白云区", "黄埔区", "番禺区", "花都区", "南沙区", "增城区", "从化区"],
                "深圳市": ["福田区", "南山区", "宝安区", "龙岗区", "盐田区", "光明区", "坪山区", "龙华区", "大鹏新区"],
                # 在这里继续添加广东省的其他市与区
            },
            "山东省": {
                "济南市": ["历下区", "市中区", "槐荫区", "天桥区", "历城区", "长清区", "平阴县", "济阳县", "商河县", "章丘市"],
                "青岛市": ["市南区", "市北区", "黄岛区", "崂山区", "李沧区", "城阳区", "胶州市", "即墨市", "平度市", "莱西市"],
                # 在这里继续添加山东省的其他市与区
            },
            "江苏省": {
                "南京市": ["玄武区", "秦淮区", "建邺区", "鼓楼区", "浦口区", "栖霞区", "雨花台区", "江宁区", "六合区", "溧水区", "高淳区"],
                "苏州市": ["姑苏区", "吴中区", "相城区", "虎丘区", "吴江区", "常熟市", "张家港市", "昆山市", "太仓市"],
                # 在这里继续添加江苏省的其他市与区
            },
            "浙江省": {
                "杭州市": ["上城区", "下城区", "江干区", "拱墅区", "西湖区", "滨江区", "萧山区", "余杭区", "富阳区", "临安区", "建德市", "桐庐县", "淳安县"],
                "宁波市": ["海曙区", "江北区", "北仑区", "镇海区", "鄞州区", "奉化区", "象山县", "宁海县", "余姚市", "慈溪市"],
                # 在这里继续添加浙江省的其他市与区
            },
            "四川省": {
                "成都市": ["锦江区", "青羊区", "金牛区", "武侯区", "成华区", "高新区", "温江区", "龙泉驿区", "新都区", "金堂县", "双流区", "郫都区", "大邑县", "蒲江县", "新津县", "都江堰市", "彭州市", "邛崃市", "崇州市", "简阳市"],
                "绵阳市": ["涪城区", "游仙区", "安州区", "三台县", "盐亭县", "梓潼县", "北川羌族自治县", "平武县", "江油市"],
                # 在这里继续添加四川省的其他市与区
            },
            "湖北省": {
                "武汉市": ["江岸区", "江汉区", "硚口区", "汉阳区", "武昌区", "青山区", "洪山区", "东西湖区", "汉南区", "蔡甸区", "江夏区", "黄陂区", "新洲区"],
                "黄石市": ["黄石港区", "西塞山区", "下陆区", "铁山区", "阳新县", "大冶市"],
                # 在这里继续添加湖北省的其他市与区
            },
            "湖南省": {
                "长沙市": ["芙蓉区", "天心区", "岳麓区", "开福区", "雨花区", "望城区", "长沙县", "宁乡市", "浏阳市"],
                "株洲市": ["荷塘区", "芦淞区", "石峰区", "天元区", "渌口区", "攸县", "茶陵县", "炎陵县", "醴陵市"],
                # 在这里继续添加湖南省的其他市与区
            },
            "辽宁省": {
                "沈阳市": ["和平区", "沈河区", "大东区", "皇姑区", "铁西区", "苏家屯区", "浑南区", "沈北新区", "于洪区", "辽中区", "康平县", "法库县", "新民市"],
                "大连市": ["中山区", "西岗区", "沙河口区", "甘井子区", "旅顺口区", "金州区", "普兰店区", "长海县", "瓦房店市", "庄河市"],
                # 在这里继续添加辽宁省的其他市与区
            },
            "黑龙江省": {
                "哈尔滨市": ["道里区", "南岗区", "道外区", "平房区", "松北区", "香坊区", "呼兰区", "阿城区", "双城区", "依兰县", "方正县", "宾县", "巴彦县", "木兰县", "通河县", "延寿县", "尚志市", "五常市"],
                "齐齐哈尔市": ["龙沙区", "建华区", "铁锋区", "昂昂溪区", "富拉尔基区", "碾子山区", "梅里斯达斡尔族区", "龙江县", "依安县", "泰来县", "甘南县", "富裕县", "克山县", "克东县", "拜泉县", "讷河市"],
                # 在这里继续添加黑龙江省的其他市与区
            },
            "辽宁省": {
                "沈阳市": ["和平区", "沈河区", "大东区", "皇姑区", "铁西区", "苏家屯区", "浑南区", "沈北新区", "于洪区", "辽中区", "康平县", "法库县", "新民市"],
                "大连市": ["中山区", "西岗区", "沙河口区", "甘井子区", "旅顺口区", "金州区", "普兰店区", "长海县", "瓦房店市", "庄河市"],
                # 在这里继续添加辽宁省的其他市与区
            },
            "陕西省": {
                "西安市": ["新城区", "碑林区", "莲湖区", "灞桥区", "未央区", "雁塔区", "阎良区", "临潼区", "长安区", "高陵区", "蓝田县", "周至县", "户县"],
                "铜川市": ["王益区", "印台区", "耀州区", "宜君县"],
                # 在这里继续添加陕西省的其他市与区
            },
            "山西省": {
                "太原市": ["小店区", "迎泽区", "杏花岭区", "尖草坪区", "万柏林区", "晋源区", "清徐县", "阳曲县", "娄烦县", "古交市"],
                "大同市": ["新荣区", "平城区", "云冈区", "云州区", "阳高县", "天镇县", "广灵县", "灵丘县", "浑源县", "左云县"],
                # 在这里继续添加山西省的其他市与区
            },
            "河北省": {
                "石家庄市": ["长安区", "桥西区", "新华区", "井陉矿区", "裕华区", "藁城区", "鹿泉区", "栾城区", "井陉县", "正定县", "行唐县", "灵寿县", "高邑县", "深泽县", "赞皇县", "无极县", "平山县", "元氏县", "赵县", "晋州市", "新乐市"],
                "唐山市": ["路南区", "路北区", "古冶区", "开平区", "丰南区", "丰润区", "���妃甸区", "滦县", "滦南县", "乐亭���", "迁西县", "玉田县", "遵化市", "迁安市"],
                # 在这里继续添加河北省的其他市与区
            },
            "安徽省": {
                "合肥市": ["瑶海区", "庐阳区", "蜀山区", "包河区", "长丰县", "肥东县", "肥西县", "庐江县", "巢湖市"],
                "芜湖市": ["镜湖区", "弋江区", "鸠江区", "三山区", "芜湖县", "繁昌县", "南陵县", "无为县"],
                # 在这里继续添加安徽省的其他市与区
            },
            "甘肃省": {
                "兰州市": ["城关区", "七里河区", "西固区", "安宁区", "红古区", "永登县", "皋兰县", "榆中县"],
                "嘉峪关市": ["市辖区"],
                # 在这里继续添加甘肃省的其他市与区
            },
            "青海省": {
                "西宁市": ["城东区", "城中区", "城西区", "城北区", "大通回族土族自治县", "湟中县", "湟源县"],
                # 在这里继续添加青海省的其他市与区
            },
            "新疆维吾尔自治区": {
                "乌鲁木齐市": ["天山区", "沙依巴克区", "新市区", "水磨沟区", "头屯河区", "达坂城区", "米东区", "乌鲁木齐县"],
                "克拉玛依市": ["独山子区", "克拉玛依区", "白碱滩区", "乌尔禾区"],
                # 在这里继续添加新疆省的其他市与区
            },
            "西藏自治区": {
                "拉萨市": ["城关区", "堆龙德庆区", "林周县", "当雄县", "尼木县", "曲水县", "墨竹工卡县"],
                "昌都市": ["卡若区", "江达县", "贡觉县", "类乌齐县", "丁青县", "察雅县", "八宿县", "左贡县", "芒康县", "洛隆县", "边坝县"],
                # 在这里继续添加西藏自治区的其他市与区
            },

            "海南省": {
                "海口市": ["秀英区", "龙华区", "琼山区", "美兰区"],
                "三亚市": ["市辖区"],
                # 在这里继续添加海南省的其他市与区
            },
            "福建省": {
                "福州市": ["鼓楼区", "台江区", "仓山区", "马尾区", "晋安区", "闽侯县", "连江县", "罗源县", "闽清县", "永泰县", "平潭县", "福清市", "长乐市"],
                "厦门市": ["思明区", "海沧区", "湖里区", "集美区", "同安区", "翔安区"],
                # 在这里继续添加福建省的其他市与区
            },
            "广西壮族自治区": {
                "南宁市": ["兴宁区", "青秀区", "江南区", "西乡塘区", "良庆区", "邕宁区", "武鸣区", "隆安县", "马山县", "上林县", "宾阳县", "横县"],
                "柳州市": ["城中区", "鱼峰区", "柳南区", "柳北区", "柳江区", "柳城县", "鹿寨县", "融安县", "融水苗族自治县", "三江侗族自治县"],
                # 在这里继续添加广西省的其他市与区
            },
            "贵州省": {
                "贵阳市": ["南明区", "云岩区", "花溪区", "乌当区", "白云区", "观山湖区", "开阳县", "息烽县", "修文县", "清镇市"],
                "遵义市": ["红花岗区", "汇川区", "播州区", "桐梓县", "绥阳县", "正安县", "道真仡佬族苗族自治县", "务川仡佬族苗族自治县", "凤冈县", "湄潭县", "余庆县", "习水县", "赤水市", "仁怀市"],
                # 在这里继续添加贵州省的其他市与区
            },
            "云南省": {
                "昆明市": ["五华区", "盘龙区", "官渡区", "西山区", "东川区", "呈贡区", "晋宁区", "富民县", "宜良县", "石林彝族自治县", "嵩明县", "禄劝彝族苗族自治县", "寻甸回族彝族自治县", "安宁市"],
                "曲靖市": ["麒麟区", "沾益区", "马龙区", "陆良县", "师宗县", "罗平县", "富源县", "会泽县", "宣威市"],
                # 在这里继续添加云南省的其他市与区
            },
            "江西省": {
                "南昌市": ["东湖区", "西湖区", "青云谱区", "湾里区", "青山湖区", "新建区", "南昌县", "安义县", "进贤县"],
                "九江市": ["濂溪区", "浔阳区", "柴桑区", "武宁县", "修水县", "永修县", "德安县", "都昌县", "湖口县", "彭泽县", "瑞昌市", "共青城市"],
                # 在这里继续添加江西省的其他市与区
            },
            "河南省": {
                "郑州市": ["中原区", "二七区", "管城回族区", "金水区", "上街区", "惠济区", "中牟县", "巩义市", "荥阳市", "新密市", "新郑市", "登封市"],
                "开封市": ["龙亭区", "顺河回族区", "鼓楼区", "禹王台区", "金明区", "杞县", "通许县", "尉氏县", "兰考县"],
                "洛阳市": ["老城区", "西工区", "瀍河回族区", "涧西区", "吉利区", "洛龙区", "孟津县", "新安县", "栾川县", "嵩县", "汝阳县", "宜阳县", "洛宁县", "伊川县", "偃师市"],
                "平顶山市": ["新华区", "卫东区", "石龙区", "湛河区", "宝丰县", "叶县", "鲁山县", "郏县", "舞钢市", "汝州市"],
                "安阳市": ["文峰区", "北关区", "殷都区", "龙安区", "安阳县", "汤阴县", "滑县", "内黄县", "林州市"],
                "鹤壁市": ["鹤山区", "山城区", "淇滨区", "浚县", "淇县"],
                "新乡市": ["红旗区", "卫滨区", "凤泉区", "牧野区", "新乡县", "获嘉县", "原阳县", "延津县", "封丘县", "长垣市"],
                "焦作市": ["解放区", "中站区", "马村区", "山阳区", "修武县", "博爱县", "武陟县", "温县", "沁阳市", "孟州市"],
                "濮阳市": ["华龙区", "清丰县", "南乐县", "范县", "台前县", "濮阳县"],
                "许昌市": ["魏都区", "建安区", "鄢陵县", "襄城县", "禹州市", "长葛市"],
                "漯河市": ["源汇区", "郾城区", "召陵区", "舞阳县", "临颍县"],
                "三门峡市": ["湖滨区", "陕州区", "渑池县", "卢氏县", "义马市", "灵宝市"],
                "南阳市": ["宛城区", "卧龙区", "南召县", "方城县", "西峡县", "镇平县", "内乡县", "淅川县", "社旗县", "唐河县", "新野县", "桐柏县", "邓州市"],
                "商丘市": ["梁园区", "睢阳区", "民权县", "睢县", "宁陵县", "柘城县", "虞城县", "夏邑县", "永城市"],
                "信阳市": ["浉河区", "平桥区", "罗山县", "光山县", "新县", "商城县", "固始县", "潢川县", "淮滨县", "息县"],
                "周口市": ["川汇区", "扶沟县", "西华县", "商水县", "沈丘县", "郸城县", "淮阳县", "太康县", "鹿邑县", "项城市"],
                "驻马店市": ["驿城区", "西平县", "上蔡县", "平舆县", "正阳县", "确山县", "泌阳县", "汝南县", "遂平县", "新蔡县"]
            }
        }

        self.province_dd = ft.Dropdown(
            options=[],
            width=200,
            height=40,
            content_padding=5,
            on_change=lambda e: self.change_province_event(e.data),
        )
        self.city_dd = ft.Dropdown(
            options=[],
            width=200,
            height=40,
            content_padding=5,
            on_change=lambda e: self.change_city_event(e.data),
        )
        self.county_dd = ft.Dropdown(
            options=[],
            width=200,
            height=40,
            content_padding=5,
            on_change=lambda e: self.change_county_event(e.data),
        )
        self.select_component = ft.Row([self.province_dd, self.city_dd, self.county_dd])
        self.title_text = ft.Text()

        self.data_table = ft.DataTable(
            columns=[ft.DataColumn(ft.Text("名称")), ft.DataColumn(ft.Text("数值"))], width=600
        )
        self.close_btn = ft.IconButton(
            icon=ft.icons.CLOSE_OUTLINED, on_click=self.close_dlg
        )
        # self.area_data = {}
        self.end_update_time = ""
        super(Dialog, self).__init__(
            title=ft.Text("天气实时查询"),
            content=ft.Stack(
                [ft.Column([self.select_component, self.title_text, ft.ListView([self.data_table], height=400)])],
                width=700,
                expand=True,
            ),
            content_padding=20,
            actions=[self.close_btn],
            actions_alignment="center",
        )

    def open_dlg(self, e):
        super().open_dlg(e)
        # self.data = get_weather_info(city="101010100")
        # print(self.data)
        # if data[1] != 200:
        if self.data is 'None':
            self.title_text.value = "抱歉，查询接口出错！"
        else:
            # self.format_data(data[0])
            self.title_text.value = self.end_update_time
            provinces = list(self.area_data.keys())
            print(provinces)
            self.province_dd.options.extend([ft.dropdown.Option(i) for i in provinces])
            self.province_dd.value = provinces[0]
            self.change_province_event(provinces[0])
        self.update()


    def change_province_event(self, province):
        self.province_dd.value = province
        cities = list(self.area_data[province].keys())
        self.city_dd.options.clear()
        self.city_dd.options.extend([ft.dropdown.Option(i) for i in cities])
        self.change_city_event(cities[0])

    def change_city_event(self, city):
        self.city_dd.value = city
        province = self.province_dd.value
        counties = list(self.area_data[province][city])
        self.county_dd.options.clear()
        self.county_dd.options.extend([ft.dropdown.Option(i) for i in counties])
        self.change_county_event(counties[0])

    def change_county_event(self, county):
        self.county_dd.value = county
        province = self.province_dd.value
        city = self.city_dd.value
        self.data_table.rows.clear()
        # 从用户选择的城市名称获取对应的数字代号
        city_code = self.city_mapping.get(city)

        if city_code:
            # 调用获取天气信息的函数，并传入城市数字代号
            self.data = get_weather_info(city=city_code)
            print(self.data)
        else:
            # 处理城市名称无效的情况
            print("无效的城市名称")
        for position, level in self.data.items():
            row = ft.DataRow(
                cells=[
                    ft.DataCell(ft.Text(position, width=400, overflow="clip")),
                    ft.DataCell(ft.Text(level))
                ]
            )
            self.data_table.rows.append(row)

        self.update()

    
